<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Examen</title>
  <link rel="stylesheet" href="/css/examen.css">
</head>
<body>

  <header>
    Examen práctica EXANI
    <div><button onclick="location.href='/simulador'" class="btn-volver">Regresar</button></div>
  </header>

  {{#each preguntas}}
  <div class="contenedor-pregunta {{#if @first}}activa{{/if}}" 
       data-index="{{@index}}" data-materia="{{materia}}">
    <div class="encabezado">
      <div>Pregunta {{sum @index 1}} de {{../preguntas.length}} - <strong>{{materia}}</strong></div>
      <div class="cronometro">60:00</div>
    </div>

    <h2 class="pregunta">{{pregunta}}</h2>

    <div class="opciones">
      {{#each respuestas}}
        <button type="button">{{respuesta}}</button>
      {{/each}}
    </div>

    <div class="navegacion">
      {{#unless @first}}
        <button type="button" class="btn-volver">← Volver</button>
      {{/unless}}

      <button type="button" class="btn-volver btnNoSeguro">No seguro / Para después</button>

      {{#if @last}}
        <button type="button" class="btn-finalizar">Finalizar</button>
      {{else}}
        <button type="button" class="btn-siguiente">Siguiente →</button>
      {{/if}}
    </div>

    <div class="pulpo-container">
      <img src="../media/images/pulpo.png" alt="Pulpo" class="pulpo">
    </div>
  </div>
  {{/each}}

  <div id="pendientesContainer" class="pendientes-container" style="display:none; margin-top:10px;"></div>

  <form id="formResultados" method="POST" action="/resultados_admision" style="display:none;">
    <input type="hidden" name="respuestas" id="inputRespuestas" value="[]">
    <input type="hidden" name="idsPreguntas" id="inputIdsPreguntas" value='{{json preguntasIds}}'>
    <input type="hidden" name="pendientes" id="inputPendientes">
    <input type="hidden" name="suspensos" id="inputSuspensos">
  </form>

<script>
const preguntas = document.querySelectorAll('.contenedor-pregunta');
let actual = 0;
let respuestasUsuario = [];
let estadoPreguntas = [];
let Materia = [] // "respondida", "pendiente", "suspenso"

const TIEMPO_ADVERTENCIA = 60; // segundos para aviso de “enfrascado”
let timerAdvertencia = null;

// Inicializamos estadoPreguntas vacío
for (let i = 0; i < preguntas.length; i++) {
  estadoPreguntas[i] = "";
}

// Función para mostrar pregunta
function mostrarPregunta(index) {
  if (index < 0 || index >= preguntas.length) return;
  preguntas.forEach(p => p.classList.remove('activa'));
  preguntas[index].classList.add('activa');
  actual = index;

  // Mostrar pendientes solo si es la última pregunta
  if (actual === preguntas.length - 1) {
    actualizarPendientesUI();
  } else {
    document.getElementById('pendientesContainer').style.display = 'none';
  }

  reiniciarTimerAdvertencia(); // Reinicia el aviso de tiempo
}

// Función de advertencia por estar mucho tiempo en la misma pregunta
function reiniciarTimerAdvertencia() {
  if (timerAdvertencia) clearTimeout(timerAdvertencia);
  timerAdvertencia = setTimeout(() => {
    alert(`¡Ojo! Llevas mucho tiempo en la pregunta ${actual + 1}. Considera avanzar o marcarla para después.`);
  }, TIEMPO_ADVERTENCIA * 1000);
}

// Actualizar pendientes y suspensos mostrando materia
function actualizarPendientesUI() {
  const cont = document.getElementById('pendientesContainer');
  cont.innerHTML = "";

  let hayPendientes = false;
  estadoPreguntas.forEach((estado, i) => {
    if (estado === "pendiente" || estado === "suspenso") {
      hayPendientes = true;
      const div = document.createElement('div');
      const tipo = estado === "pendiente" ? "en pendiente" : 'marcada "para después"';
      const materia = preguntas[i].dataset.materia || "Materia desconocida";
      div.textContent = `Pregunta ${i + 1} (${materia}) ${tipo}.`;
      div.style.cursor = "pointer";
      div.addEventListener('click', () => mostrarPregunta(i));
      cont.appendChild(div);
    }
  });

  cont.style.display = hayPendientes ? 'block' : 'none';
}

// Botón "Para después"
document.querySelectorAll('.btnNoSeguro').forEach((btn, indexPregunta) => { 
  btn.addEventListener('click', (e) => { 
    e.preventDefault(); 
    estadoPreguntas[indexPregunta] = "suspenso"; 
    actualizarPendientesUI(); 
    mostrarPregunta(actual + 1); 
  }); 
});

// Selección de respuestas
document.querySelectorAll('.opciones').forEach((opcionesDiv, preguntaIndex) => {
  const botones = opcionesDiv.querySelectorAll('button');
  botones.forEach((btn, respuestaIndex) => {
    btn.addEventListener('click', () => {
      botones.forEach(b => b.classList.remove('seleccionada'));
      btn.classList.add('seleccionada');
      respuestasUsuario[preguntaIndex] = respuestaIndex;
      estadoPreguntas[preguntaIndex] = "respondida";
    });
  });
});

// Botón Siguiente
document.querySelectorAll('.btn-siguiente').forEach(btn => {
  btn.addEventListener('click', () => {
    if (!estadoPreguntas[actual]) estadoPreguntas[actual] = "pendiente";
    mostrarPregunta(actual + 1);
  });
});

// Botón Volver
document.querySelectorAll('.btn-volver').forEach(btn => {
  btn.addEventListener('click', () => mostrarPregunta(actual - 1));
});

// Botón Finalizar
document.querySelectorAll('.btn-finalizar').forEach(btn => {
  btn.addEventListener('click', () => {
    estadoPreguntas.forEach((e,i) => {
      if (respuestasUsuario[i] === undefined && e !== "suspenso") {
        estadoPreguntas[i] = "pendiente";
      }
    });
    document.getElementById('inputRespuestas').value = JSON.stringify(respuestasUsuario);
    document.getElementById('inputPendientes').value = JSON.stringify(
      estadoPreguntas.map((e,i)=> e==="pendiente"?i:null).filter(i=>i!==null)
    );
    document.getElementById('inputSuspensos').value = JSON.stringify(
      estadoPreguntas.map((e,i)=> e==="suspenso"?i:null).filter(i=>i!==null)
    );
    document.getElementById('formResultados').submit();
  });
});

// Cronómetro global
let tiempoRestante = 60 * 60; // 60 minutos
function actualizarCronometro() {
  const minutos = Math.floor(tiempoRestante / 60);
  const segundos = tiempoRestante % 60;
  const texto = `${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
  document.querySelectorAll('.cronometro').forEach(c => c.textContent = texto);
  if (tiempoRestante > 0) tiempoRestante--;
  else {
    clearInterval(intervalo);
    alert('¡Tiempo terminado!');
    window.location.href = '/menu_principal';
  }
}
const intervalo = setInterval(actualizarCronometro, 1000);

// Inicia examen
mostrarPregunta(0);
</script>

</body>
</html>
